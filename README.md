### 0. 加密云——ABE

这是一个在Go语言编写的网盘项目https://github.com/Aries-hash/filestore-server 的基础上结合2017年FAME加密技术实现的加密云，提供加密上传和加密下载功能。

原项目由于使用的相关框架go-micro，consul，traefik等版本更新过大，原代码已经无法使用。本项目已按照其逻辑在go-micro最新v4版本下重新实现并加入加密功能。

展示页面：http://47.122.61.132:8080/welcome

### 1. 系统架构-交互逻辑

<img width="728" alt="加密云架构图" src="https://github.com/qs3c/fileserver-ABE/assets/106737061/a16dfcca-8e33-4bfb-84d0-ed36733bb121">

**五个自编写服务（蓝色和绿色）：**

1. 用户服务：负责注册，登录，查询用户信息等。（拆分成了监听8080端口的入口服务和具体处理逻辑的用户服务，其实本质上是一个服务。）
2. 上传服务：监听28080端口，负责文件上传和加密上传。
3. 转移服务：负责通过从Rabbitmq中获取来自上传服务发送的信息，根据信息将目标文件转移至阿里云OSS。
4. 下载服务：监听38080端口，负责文件下载和加密文件下载。
5. 数据库服务：负责和本地基础服务Mysql交互处理数据记录。

\* 除了上传外服务标记为蓝色，它们被打包成镜像后运行在docker上，上传服务因为涉及加密调用本地python脚本，做成镜像以docker运行较为复杂，暂时以`nohup go run main.go &` 运行在后台。

**三个本地docker运行基础服务（橙色）：**

1. Mysql数据库服务
2. Consul服务发现中心服务(自编写的五个服务都需要注册到Consul中，都和Consul有连线，这里省略它们和Consul的连线。)
3. Rabbitmq消息队列服务

**一个外部服务（红色）：**

1. 阿里云OSS

### 2. 实现功能

- [x] Gin实现的普通文件上传下载服务
- [x] Mysql存储—“唯一文件表”，“用户文件表”，“用户信息表”
- [x] 文件秒传功能
- [x] 加密上传功能
- [x] 使用阿里云OSS对象存储服务
- [x] RabbitMQ消息队列实现文件异步转移OSS
- [x] RabbitMQ消息队列实现Go服务和Python脚本数据通信
- [x] 微服务化（API网关，服务注册，RPC通讯）
- [x] 打包成Docker镜像
- [ ] 重命名/删除文件功能
- [ ] 分块上传功能
- [ ] Traefik反向代理

### 3. 细节说明/使用指南/bug合集/TODO

1. 这是一个简易的用户注册登录界面，注册需要用户名长度大于3密码长度大于5才合法，不合法会提示注册失败，但无失败原因提示。
2. 登录时输入错误密码，无法成功登录，暂无有效提示。
3. 暂未实现重命名/删除功能。
4. 在home页面，即用户文件信息展示页面，普通**上传**文件对应**下载**按钮，**加密上传**文件对应**加密下载**按钮，加密上传文件有[enc]标记，对普通文件进行加密下载会失败，对加密文件普通下载也会失败，暂无有效提示信息。
5. 普通上传的转移阿里云OSS是异步的，而加密上传暂时使用的是同步转移阿里云OSS，受所租用服务器带宽影响，如果文件较大，这个过程可能会很慢。
6. 没有上传进度提示，上传过大的视频文件会没有提示和反应，耐心等待即可。
7. 由于需要本地客户端来实现分块上传，浏览器不便实现，暂无分块上传功能。
8. Traefik代理需要备案域名，暂时通过docker到主机的端口映射提供服务。

### 4. 加密功能介绍

FAME是2017年在CCS会议上提出的一种高效的属性加密技术：https://github.com/sagrawal87/ABE ，其原作者基于Python的charm-crypto库实现。

1. 这里我们通过Go执行python脚本aes_key_gen.py，这个脚本会生成随机密钥Key，并把Key通过Rabbitmq发送给Go，并从Rabbitmq获取Go发送的“访问结构”和“指定路径”，它根据访问结构对密钥Key进行加密，然后把FAME加密的Key写入指定路径。
2. Go从Rabbitmq获取python脚本随机产生的Key，并使用这个Key对文件进行aes对称加密，将加密后的文件写入指定路径。
3. FAME加密的aes Key 和 经过aes Key 加密的密文被存入相同的指定路径中。
4. 加密上传的文件，在用户文件列表中（即home页面）名称以[enc]前缀表示，代表是加密上传的文件，该类文件需要点击加密下载，不可点击下载。（同理普通上传文件下载应点击下载而不是加密下载）
5. 点击加密下载将会连续下载两个文件分别是密文和加密后的对称密钥。
6. 本服务适合各类图片文档类小文件上传。服务端通过循环读取写入的方式实现文件写入，因此可以上传较大文件，但由于没有下载进度提示，上传过大的视频文件会没有提示和反应，耐心等待即可。
7. 输入访问结构界面，可以根据下方提示来进行访问结构的键入，也可以直接复制下方的访问结构示例。
8. 解密需要在本地运行python脚本，恢复出加密文件的aes Key，然后运行Go解密程序用aes Key对加密文件复原。

### 5. 如何启动
